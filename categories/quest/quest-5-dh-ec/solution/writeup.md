### Старая база

| Событие | Название | Категория | Сложность |
| :------ | ---- | ---- | ---- |
| VKA-CTF`2021 | Старая база | Crypto | hard |

### Описание

> Автор: Dart Vader / iC0nst
>
>Прибыв на Плутон, девочка обнаружила какую-то заброшенную тюрьму, а вокруг ни души. Алиса нашла панель управления, на экраны выводилась запись с камер. По камерам видно, что внутри есть люди. Их надо выпустить, может они что-то знают об отце! Дальнейшее исследование навело Алису на необычную охранную систему, для получения доступа надо ввести расшифрованную фразу. Странный алгоритм, что-то знакомое . . .

> nc 65.21.151.249 23000
[файл](give/main.py)
### Решение
К сожалению, из-за случайной ошибки в исходник попал секретный ключ, который предполагалось найти и который необходим был для расшифровки и получения флага, это все существенно облегчало таску. Дальше представлено, как таска задумывалась и должна была решаться. 
Имеется сервис по обмену ключами по протоколу Диффи-Хеллмана на ЭК с предоставлением исходных кодов. Есть возможность зашифровать какие-лмбо данные, используя собственную точку ЭК, флаг же выдается в зашифрованном виде через AES CBC на приватном ключе ![](images/k.PNG), верхний предел ![](images/u.PNG) которого известен, также известен открытый ключ ![](images/q_k_g.PNG).
В общем виде атака имеет название: ["Invalid Curve Point Attack"](https://github.com/ashutosh1206/Crypton/blob/master/Diffie-Hellman-Key-Exchange/Attack-Invalid-Curve-Point/README.md).

Проведение атаки на данный сервис:

1. При исследовании исходных кодов можно прийти к выводу, что поданные на вход точки ЭК не проверяются на принадлежность данной кривой. Также из формулы сложения точек известно, что параметр ![](images/b.PNG) в нем не участвует. Из этого следует главный вывод, что на вход можно подавать любые точки, которые без проблем будут участвовать в вычислении общего ключа.

2. Необходимо сгенерировать несколько кривых (~40), для этого необходимо перебирать ![](images/b.PNG) = 1...40 и находить порядок этих кривых, выбирать следует те, у которых в разложении порядка есть множители до 10 000 (этого вполне будет достаточно):

![](images/E1.PNG), где порядок кривой - ![](images/n1.PNG);

![](images/E2.PNG), где порядок кривой - ![](images/n2.PNG);

и т.д.

3. Имея базовую точку ![](images/Gi.PNG) i-ой ЭК сгенерировать точку с порядком до 10 000:
![](images/ni_pi_g.PNG) , где 1000<![](images/pi.PNG)<10000 и является простым.

4. Полученные точки послать на вход программы вместе с любым сообщением, получить зашифрованное сообщение. 

5. Так как ключом для зашифрованных сообщений является координата X от точки ![](images/k_pi.PNG) то можно определить ![](images/k_ki.PNG), перебрав ключи для AES CBC, имея пару открытый текст-зашифрованный текст. 
   Так как, ![](images/ki__ki.PNG) , то чтобы исключить неопределенность, необходимо поставить вопрос нахождения ![](images/k_2.PNG), тогда нас будет интересовать нахождение ![](images/ki_2.PNG).


6. Таким образом получим множество:

![](images/k_2_k1_2.PNG);

![](images/k_2_k2_2.PNG);

![](images/k_2_k3_2.PNG);

   и т.д.

   Далее необходимо использовать Китайскую теорему об остатках , помним, что ![](images/u_2.PNG), чтобы можно было извлечь квадратный корень. 

7. Извлекаем квадратный корень и получаем приватный ключ ![](images/k.PNG), проверяем, что ![](images/q_k_g.PNG). Получаем зашифрованный флаг и расшифровываем его.

**Флаг:**

> vka{there_is_no_point_to_be_invalid_point}
