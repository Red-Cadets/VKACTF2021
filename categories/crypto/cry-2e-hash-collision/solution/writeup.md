## Дубль

| Событие | Название | Категория | Сложность |
| :------ | ---- | ---- | ---- |
| VKACTF 2021 | Дубль | Crypto | easy |

### Описание

> Автор: iC0nst
>
> Наш центр на спутнике Марса Деймосе недавно перехватил сведения, в которых говорилось о новых местах добычи урана в Солнечной системе, но они все зашифрованы двойным шифрованием, проклятые капиталисты! Нам нужны эти сведения.

> nc 65.21.151.249 42000
[файл](give/main.py)

### Решение
Имеется сервис предоставления информации о местах добычи урана в зашифрованном виде и его исходные коды. Для защиты данных используется RC4-шифрование, проводимое двукратно на одном ключе, но с разными nonce, генерация которых зависит от вводимых пользователем паролей. Известно, что RC4 - поточный шифр. Хоть пользователь и контролирует генерацию , если они разные, не зная ключ, расшифровать сообщение не представляется возможным. 

```python
nonce = os.urandom(4).hex().encode()
nonce1 = pbkdf2_hmac('sha256', userInput1, b'salt', 100000, dklen=32) + nonce
nonce2 = pbkdf2_hmac('sha256', userInput2, b'salt', 100000, dklen=32) + nonce
```



Видно, что для выработки nonce используется хэш PBKDF2-HMAC-SHA256, который работает только с первыми несколькими байтами, а если длина сообщения превышает 65 байт, то берётся хэш-сумма SHA256, которая используется далее в процессе хеширования, что даёт возможность легко создать коллизию. 

То есть **PBKDF2_HMAC_SHA256(m) == PBKDF2_HMAC_SHA256(sha256(m[:65]))**, если длина m больше 65. 

Использовав это свойство и получив nonce-ы, сервис сам вернёт сообщение в расшифрованном виде, поскольку сгенерированные гаммы самоуничтожатся операцией XOR. 

```python 
from pwn import remote
from binascii import * 
from hashlib import sha256

io = remote(IP, PORT)
io.recvuntil(": ")
io.sendline(hexlify(sha256(65 * b"a" + b"secret").digest()))
io.recvuntil(": ")
io.sendline(hexlify(65 * b"a" + b"secret"))
flag = unhexlify(io.readline().strip().decode()).decode()
```

**Флаг:**

> vka{double_encryption_is_sometimes_useless}